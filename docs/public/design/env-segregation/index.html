<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title> - Light Ecosystem for Microservices</title>
    <meta name="generator" content="Hugo 0.20.6" />

    
    <meta name="description" content="Light Document">
    
    <link rel="canonical" href="https://networknt.github.io/design/env-segregation/">
    
    <meta name="author" content="Steve Hu">
    

    <meta property="og:url" content="https://networknt.github.io/design/env-segregation/">
    <meta property="og:title" content="Light Ecosystem for Microservices">
    <meta property="og:image" content="https://networknt.github.io/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light Ecosystem for Microservices">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/fonts/icon.eot');
        src: url('https://networknt.github.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-doc" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Light Ecosystem for Microservices <span class="version">1.4.4</span></strong>
        
          <br>
          networknt/light-doc
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-doc/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-doc/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Design" href="https://networknt.github.io/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Middleware" href="https://networknt.github.io/middleware/">
	
	Middleware
</a>



  
</li>



<li>
  
    



<a  title="Server Components" href="https://networknt.github.io/server/">
	
	Server Components
</a>



  
</li>



<li>
  
    



<a  title="Client Components" href="https://networknt.github.io/client/">
	
	Client Components
</a>



  
</li>



<li>
  
    



<a  title="DevOps" href="https://networknt.github.io/devops/">
	
	DevOps
</a>



  
</li>



<li>
  
    



<a  title="Benchmark" href="https://networknt.github.io/benchmark/">
	
	Benchmark
</a>



  
</li>



<li>
  
    



<a  title="Tutorial" href="https://networknt.github.io/tutorial/">
	
	Tutorial
</a>



  
</li>



<li>
  
    



<a  title="Example" href="https://networknt.github.io/example/">
	
	Example
</a>



  
</li>



<li>
  
    



<a  title="Tool" href="https://networknt.github.io/tool/">
	
	Tool
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-doc/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="FAQ" href="https://networknt.github.io/faq/">
	
	FAQ
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1> </h1>

			

<h1 id="environment-segregation">Environment Segregation</h1>

<p>There are two goals for environment segregation:</p>

<ul>
<li>Prevent cross fire</li>
</ul>

<p>For example, UAT test accesses production services or production application accidentally accesses test
database etc.</p>

<ul>
<li>Support multiple instances for testing</li>
</ul>

<p>For example, one service in testing has multiple backend database and different departments will hit their
own instance which connects to their particular database.</p>

<p>The above use cases are pretty complicated even in traditional monolithic application. In microservices
architecture, it is even more complicated as there are two many services involves and each service has
many instances.</p>

<h2 id="to-prevent-cross-fire">To prevent cross fire</h2>

<p>In <a href="https://github.com/networknt/light-4j">light-4j</a> framework, we are using <a href="https://github.com/networknt/light-oauth2">light-oauth2</a>
to separate different environments. For each environment, there is a oauth2 provider to sign JWT token
with its private key. All the services that is deployed to that environment will have the public key from
the provider. So even if there is an UAT service trying to access a production service, the token provided
by the caller cannot be verified due to invalid signature. Given above explanation, there is no way that
we can have cross fire if configuration for each application and service is correct.</p>

<p>So how can we prevent mistakes when deploy services to the cloud environment? How can we make sure that
the configuration files won&rsquo;t be wrong during deployment? In our ecosystem, we encourage automatically
deployment without human involves so that we can eliminate human errors during deployment. Also, we have
light-config-server to serve configuration for each environment and these configuration are in separate
github repos and managed by different teams or people.</p>

<h2 id="to-support-multiple-instances-per-environment">To support multiple instances per environment</h2>

<p>One of my customers has an API developed by one line of business but it is shared by others. Each line of
business has its own test database with different set of reference tables to be populated for their own
testing. So for each API release, they have to start several instances which connect to different databases
and give the proper instance to certain QA team to test.</p>

<p>Ideally, the test environment should be consolidated to have the same reference data and similar data set
as production; however, is has been this way for over a decade and it is too costly to update the test data.</p>

<p>The solution we provided is to have an environment variable in server.yml to indicate which backend database
the instance is connecting to. This additional attribute will be registered to consul for service discovery
and the service discovery logic will check the variable to add additional filter if it exists.</p>

<p>The above logic resolves service to service calls to be bound to the same environment. For the original
client, for example Java EE based web server or test tool like load runner, it must either use our client
module to do the discovery with an additional environment or they have to manually do the lookup on consul
to find the right instance with the right environment tag.</p>

<p>This solution normally will only be used in testing environment not production. In production, there should
not be an environment variable in server.yml at all so all available instances for a given serviceId will
be returned and load balanced.</p>

<h2 id="summary">Summary</h2>

<p>The above solution replaces the ad hoc solution built today in the existing monolithic service. The
existing solution pass an environment header in the request to indicate the testing and there is a
piece code to determine which database to connect based on the header. There is no environment header
on production and there should be only one database connection as default on production. We cannot
follow this approach when we move to microservices architecture so we found a way to resolve it at
the framework level instead.</p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://networknt.github.io/" title="Introduction">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Introduction
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/design/multi-tenancy/" title="">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/';
      var repo_id  = 'networknt\/light-doc';
    
    </script>

    <script src="https://networknt.github.io/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

