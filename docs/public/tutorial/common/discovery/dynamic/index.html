<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Dynamic service discovery with direct registry - Light Ecosystem for Microservices</title>
    <meta name="generator" content="Hugo 0.21-DEV" />

    
    <meta name="description" content="Light Document">
    
    <link rel="canonical" href="https://networknt.github.io/tutorial/common/discovery/dynamic/">
    
    <meta name="author" content="Steve Hu">
    

    <meta property="og:url" content="https://networknt.github.io/tutorial/common/discovery/dynamic/">
    <meta property="og:title" content="Light Ecosystem for Microservices">
    <meta property="og:image" content="https://networknt.github.io/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light Ecosystem for Microservices">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/fonts/icon.eot');
        src: url('https://networknt.github.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Dynamic service discovery with direct registry
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-doc" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Light Ecosystem for Microservices <span class="version">1.4.4</span></strong>
        
          <br>
          networknt/light-doc
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-doc/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-doc/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Design" href="https://networknt.github.io/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Middleware" href="https://networknt.github.io/middleware/">
	
	Middleware
</a>



  
</li>



<li>
  
    



<a  title="Server Components" href="https://networknt.github.io/server/">
	
	Server Components
</a>



  
</li>



<li>
  
    



<a  title="Client Components" href="https://networknt.github.io/client/">
	
	Client Components
</a>



  
</li>



<li>
  
    



<a  title="DevOps" href="https://networknt.github.io/devops/">
	
	DevOps
</a>



  
</li>



<li>
  
    



<a  title="Benchmark" href="https://networknt.github.io/benchmark/">
	
	Benchmark
</a>



  
</li>



<li>
  
    



<a  title="Tutorial" href="https://networknt.github.io/tutorial/">
	
	Tutorial
</a>



  
</li>



<li>
  
    



<a  title="Example" href="https://networknt.github.io/example/">
	
	Example
</a>



  
</li>



<li>
  
    



<a  title="Tool" href="https://networknt.github.io/tool/">
	
	Tool
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-doc/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="FAQ" href="https://networknt.github.io/faq/">
	
	FAQ
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Dynamic service discovery with direct registry </h1>

			

<p>The above step uses static urls defined in configuration files. It won&rsquo;t work in a
dynamic clustered environment as there are more instances of each service. In this
step, we are going to use cluster component with direct registry so that we don&rsquo;t
need to start external consul or zookeeper instances. We still go through registry
for service discovery but the registry is defined in service.yml. Next step we
will use consul server for the discovery to mimic real production environment.</p>

<p>With direct registry in service.yml, we can easily move to consul for service
discovery without changing the code. Each service can be package with docker
and utilize different service discovery option by change the configuration in
service.yml file.</p>

<p>First let&rsquo;s create a folder from static to dynamic.</p>

<pre><code>cd ~/networknt/light-example-4j/discovery/api_a
cp -r static dynamic
cd ~/networknt/light-example-4j/discovery/api_b
cp -r static dynamic
cd ~/networknt/light-example-4j/discovery/api_c
cp -r static dynamic
cd ~/networknt/light-example-4j/discovery/api_d
cp -r static dynamic
</code></pre>

<h3 id="api-a">API A</h3>

<p>Let&rsquo;s update API A Handler to use Cluster instance instead of using static config
files.</p>

<p>DataGetHandler.java</p>

<pre><code>package com.networknt.apia.handler;

import com.fasterxml.jackson.core.type.TypeReference;
import com.networknt.client.Http2Client;
import com.networknt.cluster.Cluster;
import com.networknt.config.Config;
import com.networknt.exception.ClientException;
import com.networknt.security.JwtHelper;
import com.networknt.server.Server;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.UndertowOptions;
import io.undertow.client.ClientConnection;
import io.undertow.client.ClientRequest;
import io.undertow.client.ClientResponse;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import io.undertow.util.Methods;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xnio.OptionMap;

import java.net.URI;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.atomic.AtomicReference;

public class DataGetHandler implements HttpHandler {
    static Logger logger = LoggerFactory.getLogger(DataGetHandler.class);
    static Cluster cluster = SingletonServiceFactory.getBean(Cluster.class);
    static String apibHost;
    static String apicHost;
    static String path = &quot;/v1/data&quot;;
    static Map&lt;String, Object&gt; securityConfig = (Map)Config.getInstance().getJsonMapConfig(JwtHelper.SECURITY_CONFIG);
    static boolean securityEnabled = (Boolean)securityConfig.get(JwtHelper.ENABLE_VERIFY_JWT);
    static String tag = Server.config.getEnvironment();

    static Http2Client client = Http2Client.getInstance();
    static ClientConnection connectionB;
    static ClientConnection connectionC;

    public DataGetHandler() {
        try {
            apibHost = cluster.serviceToUrl(&quot;https&quot;, &quot;com.networknt.apib-1.0.0&quot;, tag, null);
            apicHost = cluster.serviceToUrl(&quot;https&quot;, &quot;com.networknt.apic-1.0.0&quot;, tag, null);
            connectionB = client.connect(new URI(apibHost), Http2Client.WORKER, Http2Client.SSL, Http2Client.POOL, OptionMap.create(UndertowOptions.ENABLE_HTTP2, true)).get();
            connectionC = client.connect(new URI(apicHost), Http2Client.WORKER, Http2Client.SSL, Http2Client.POOL, OptionMap.create(UndertowOptions.ENABLE_HTTP2, true)).get();
        } catch (Exception e) {
            logger.error(&quot;Exeption:&quot;, e);
        }
    }

    @Override
    public void handleRequest(HttpServerExchange exchange) throws Exception {
        List&lt;String&gt; list = new ArrayList&lt;&gt;();
        if(connectionB == null || !connectionB.isOpen()) {
            try {
                apibHost = cluster.serviceToUrl(&quot;https&quot;, &quot;com.networknt.apib-1.0.0&quot;, tag, null);
                connectionB = client.connect(new URI(apibHost), Http2Client.WORKER, Http2Client.SSL, Http2Client.POOL, OptionMap.create(UndertowOptions.ENABLE_HTTP2, true)).get();
            } catch (Exception e) {
                logger.error(&quot;Exeption:&quot;, e);
                throw new ClientException(e);
            }
        }
        if(connectionC == null || !connectionC.isOpen()) {
            try {
                apicHost = cluster.serviceToUrl(&quot;https&quot;, &quot;com.networknt.apic-1.0.0&quot;, tag, null);
                connectionC = client.connect(new URI(apicHost), Http2Client.WORKER, Http2Client.SSL, Http2Client.POOL, OptionMap.create(UndertowOptions.ENABLE_HTTP2, true)).get();
            } catch (Exception e) {
                logger.error(&quot;Exeption:&quot;, e);
                throw new ClientException(e);
            }
        }
        final CountDownLatch latch = new CountDownLatch(2);
        final AtomicReference&lt;ClientResponse&gt; referenceB = new AtomicReference&lt;&gt;();
        final AtomicReference&lt;ClientResponse&gt; referenceC = new AtomicReference&lt;&gt;();
        try {
            ClientRequest requestB = new ClientRequest().setMethod(Methods.GET).setPath(path);
            if(securityEnabled) client.propagateHeaders(requestB, exchange);
            connectionB.sendRequest(requestB, client.createClientCallback(referenceB, latch));

            ClientRequest requestC = new ClientRequest().setMethod(Methods.GET).setPath(path);
            if(securityEnabled) client.propagateHeaders(requestC, exchange);
            connectionC.sendRequest(requestB, client.createClientCallback(referenceC, latch));

            latch.await();

            int statusCodeB = referenceB.get().getResponseCode();
            if(statusCodeB &gt;= 300){
                throw new Exception(&quot;Failed to call API B: &quot; + statusCodeB);
            }
            List&lt;String&gt; apibList = Config.getInstance().getMapper().readValue(referenceB.get().getAttachment(Http2Client.RESPONSE_BODY),
                    new TypeReference&lt;List&lt;String&gt;&gt;(){});
            list.addAll(apibList);

            int statusCodeC = referenceC.get().getResponseCode();
            if(statusCodeC &gt;= 300){
                throw new Exception(&quot;Failed to call API C: &quot; + statusCodeC);
            }
            List&lt;String&gt; apicList = Config.getInstance().getMapper().readValue(referenceC.get().getAttachment(Http2Client.RESPONSE_BODY),
                    new TypeReference&lt;List&lt;String&gt;&gt;(){});
            list.addAll(apicList);
        } catch (Exception e) {
            logger.error(&quot;Exception:&quot;, e);
            throw new ClientException(e);
        }
        list.add(&quot;API A: Message 1&quot;);
        list.add(&quot;API A: Message 2&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(list));
    }
}

</code></pre>

<p>Also, we need service.yml to inject several singleton implementations of
Cluster, LoadBanlance, URL and Registry. Please note that the key in parameters
is serviceId of your calling APIs</p>

<pre><code>singletons:
- com.networknt.registry.URL:
  - com.networknt.registry.URLImpl:
      protocol: https
      host: localhost
      port: 8080
      path: direct
      parameters:
        com.networknt.apib-1.0.0: https://localhost:7442
        com.networknt.apic-1.0.0: https://localhost:7443
- com.networknt.registry.Registry:
  - com.networknt.registry.support.DirectRegistry
- com.networknt.balance.LoadBalance:
  - com.networknt.balance.RoundRobinLoadBalance
- com.networknt.cluster.Cluster:
  - com.networknt.cluster.LightCluster

</code></pre>

<p>As we don&rsquo;t need api_a.yml anymore, it can be removed.</p>

<h3 id="api-b">API B</h3>

<p>DataGetHandler.java</p>

<pre><code>package com.networknt.apib.handler;

import com.fasterxml.jackson.core.type.TypeReference;
import com.networknt.client.Http2Client;
import com.networknt.cluster.Cluster;
import com.networknt.config.Config;
import com.networknt.exception.ClientException;
import com.networknt.security.JwtHelper;
import com.networknt.server.Server;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.UndertowOptions;
import io.undertow.client.ClientConnection;
import io.undertow.client.ClientRequest;
import io.undertow.client.ClientResponse;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.Methods;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xnio.OptionMap;

import java.net.URI;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.atomic.AtomicReference;

public class DataGetHandler implements HttpHandler {
    static Logger logger = LoggerFactory.getLogger(DataGetHandler.class);
    static Cluster cluster = SingletonServiceFactory.getBean(Cluster.class);
    static String apidHost;
    static String path = &quot;/v1/data&quot;;
    static Map&lt;String, Object&gt; securityConfig = (Map)Config.getInstance().getJsonMapConfig(JwtHelper.SECURITY_CONFIG);
    static boolean securityEnabled = (Boolean)securityConfig.get(JwtHelper.ENABLE_VERIFY_JWT);
    static String tag = Server.config.getEnvironment();

    static Http2Client client = Http2Client.getInstance();
    static ClientConnection connection;

    public DataGetHandler() {
        try {
            apidHost = cluster.serviceToUrl(&quot;https&quot;, &quot;com.networknt.apid-1.0.0&quot;, tag, null);
            connection = client.connect(new URI(apidHost), Http2Client.WORKER, Http2Client.SSL, Http2Client.POOL, OptionMap.create(UndertowOptions.ENABLE_HTTP2, true)).get();
        } catch (Exception e) {
            logger.error(&quot;Exeption:&quot;, e);
        }
    }

    @Override
    public void handleRequest(HttpServerExchange exchange) throws Exception {
        List&lt;String&gt; list = new ArrayList&lt;&gt;();
        final CountDownLatch latch = new CountDownLatch(1);
        if(connection == null || !connection.isOpen()) {
            try {
                apidHost = cluster.serviceToUrl(&quot;https&quot;, &quot;com.networknt.apid-1.0.0&quot;, tag, null);
                connection = client.connect(new URI(apidHost), Http2Client.WORKER, Http2Client.SSL, Http2Client.POOL, OptionMap.create(UndertowOptions.ENABLE_HTTP2, true)).get();
            } catch (Exception e) {
                logger.error(&quot;Exeption:&quot;, e);
                throw new ClientException(e);
            }
        }
        final AtomicReference&lt;ClientResponse&gt; reference = new AtomicReference&lt;&gt;();
        try {
            ClientRequest request = new ClientRequest().setMethod(Methods.GET).setPath(path);
            // this is to ask client module to pass through correlationId and traceabilityId as well as
            // getting access token from oauth2 server automatically and attatch authorization headers.
            if(securityEnabled) client.propagateHeaders(request, exchange);
            connection.sendRequest(request, client.createClientCallback(reference, latch));
            latch.await();
            int statusCode = reference.get().getResponseCode();
            if(statusCode &gt;= 300){
                throw new Exception(&quot;Failed to call API D: &quot; + statusCode);
            }
            List&lt;String&gt; apidList = Config.getInstance().getMapper().readValue(reference.get().getAttachment(Http2Client.RESPONSE_BODY),
                    new TypeReference&lt;List&lt;String&gt;&gt;(){});
            list.addAll(apidList);
        } catch (Exception e) {
            logger.error(&quot;Exception:&quot;, e);
            throw new ClientException(e);
        }
        list.add(&quot;API B: Message 1&quot;);
        list.add(&quot;API B: Message 2&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(list));
    }
}
</code></pre>

<p>Inject interface implementations and define the API D url.</p>

<pre><code>singletons:
- com.networknt.registry.URL:
  - com.networknt.registry.URLImpl:
      protocol: https
      host: localhost
      port: 8080
      path: direct
      parameters:
        com.networknt.apid-1.0.0: https://localhost:7444
- com.networknt.registry.Registry:
  - com.networknt.registry.support.DirectRegistry
- com.networknt.balance.LoadBalance:
  - com.networknt.balance.RoundRobinLoadBalance
- com.networknt.cluster.Cluster:
  - com.networknt.cluster.LightCluster

</code></pre>

<p>As we don&rsquo;t need api_b.yml anymore, it can be removed.</p>

<h3 id="api-c">API C</h3>

<p>API C is not calling any other APIs, so there is no change to its handler.</p>

<h3 id="api-d">API D</h3>

<p>API D is not calling any other APIs, so there is no change to its handler.</p>

<h3 id="start-servers">Start Servers</h3>

<p>Now let&rsquo;s start all four servers from four terminals.</p>

<p>API A</p>

<pre><code>cd ~/networknt/light-example-4j/discovery/api_a/dynamic
mvn clean install exec:exec
</code></pre>

<p>API B</p>

<pre><code>cd ~/networknt/light-example-4j/discovery/api_b/dynamic
mvn clean install exec:exec

</code></pre>

<p>API C</p>

<pre><code>cd ~/networknt/light-example-4j/discovery/api_c/dynamic
mvn clean install exec:exec

</code></pre>

<p>API D</p>

<pre><code>cd ~/networknt/light-example-4j/discovery/api_d/dynamic
mvn clean install exec:exec

</code></pre>

<h3 id="test-servers">Test Servers</h3>

<p>Let&rsquo;s access API A and see if we can get messages from all four servers.</p>

<pre><code>curl http://localhost:7001/v1/data

</code></pre>

<p>The result is</p>

<pre><code>[&quot;API C: Message 1&quot;,&quot;API C: Message 2&quot;,&quot;API D: Message 1&quot;,&quot;API D: Message 2&quot;,&quot;API B: Message 1&quot;,&quot;API B: Message 2&quot;,&quot;API A: Message 1&quot;,&quot;API A: Message 2&quot;]
</code></pre>

<p>In this step, we are using direct registry service registry and discovery so that it
can be easily replaced with consul discovery later on without changing the code. In
the next step, we are going to start multiple instances of API D and see how direct
registry to handle the situation.</p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://networknt.github.io/tutorial/common/discovery/multiple/" title="Multiple API D Instances">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Multiple API D Instances
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/tutorial/common/discovery/" title="Service Registry and Discovery Tutorial">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Service Registry and Discovery Tutorial
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/';
      var repo_id  = 'networknt\/light-doc';
    
    </script>

    <script src="https://networknt.github.io/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

