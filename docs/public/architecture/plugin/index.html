<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Plugin Architecture - Light Ecosystem for Microservices</title>
    <meta name="generator" content="Hugo 0.21-DEV" />

    
    <meta name="description" content="Light Document">
    
    <link rel="canonical" href="https://networknt.github.io/architecture/plugin/">
    
    <meta name="author" content="Steve Hu">
    

    <meta property="og:url" content="https://networknt.github.io/architecture/plugin/">
    <meta property="og:title" content="Light Ecosystem for Microservices">
    <meta property="og:image" content="https://networknt.github.io/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light Ecosystem for Microservices">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/fonts/icon.eot');
        src: url('https://networknt.github.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Plugin Architecture
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-doc" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Light Ecosystem for Microservices <span class="version">1.4.4</span></strong>
        
          <br>
          networknt/light-doc
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-doc/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-doc/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Design" href="https://networknt.github.io/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Middleware" href="https://networknt.github.io/middleware/">
	
	Middleware
</a>



  
</li>



<li>
  
    



<a  title="Server Components" href="https://networknt.github.io/server/">
	
	Server Components
</a>



  
</li>



<li>
  
    



<a  title="Client Components" href="https://networknt.github.io/client/">
	
	Client Components
</a>



  
</li>



<li>
  
    



<a  title="DevOps" href="https://networknt.github.io/devops/">
	
	DevOps
</a>



  
</li>



<li>
  
    



<a  title="Benchmark" href="https://networknt.github.io/benchmark/">
	
	Benchmark
</a>



  
</li>



<li>
  
    



<a  title="Tutorial" href="https://networknt.github.io/tutorial/">
	
	Tutorial
</a>



  
</li>



<li>
  
    



<a  title="Example" href="https://networknt.github.io/example/">
	
	Example
</a>



  
</li>



<li>
  
    



<a  title="Tool" href="https://networknt.github.io/tool/">
	
	Tool
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-doc/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="FAQ" href="https://networknt.github.io/faq/">
	
	FAQ
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Plugin Architecture </h1>

			

<p>In the framework design, we have adopted the same principal of microservices architecture to break
down the entire framework into smaller pieces so that each can be customized and replaced if
necessary. The only difference is that all the modules in the framework are wired in request/response
chain for best performance.</p>

<p><img src="https://networknt.github.io/images/light_java_component.png" alt="component" /></p>

<p>There are four type of components that can be wired in at different stage of the server start up. The
following is the loading sequence.</p>

<ul>
<li>Startup Hook Providers</li>
<li>Shutdown Hook Providers</li>
<li>Handler Provider</li>
<li>Middleware Handlers</li>
</ul>

<p><img src="https://networknt.github.io/images/startup_sequence.png" alt="startup_sequence" /></p>

<h1 id="plugin-implementation">Plugin implementation</h1>

<p>There are so many way to implement plugins and wire in different implementations of the same
interface. Spring is one of the popular ways. However, it will make our framework depending on
a version of spring framework and that can cause a lot of problems if the API handlers are
using different version of spring framework. Also, we don&rsquo;t want to make the framework depending
on spring and force everyone to include it. In the end, we are using Java SPI
(Service Provider Interface). In your generated API project, you can find four files in
/src/main/resources/META-INF/services. These files contains plugins to be loaded/executed during
server startup and shutdown.</p>

<h1 id="shutdown-hook-providers">Shutdown Hook Providers</h1>

<p>Shutdown hook providers are plugins that would be called during server shutdown in order to release
resources. For example, close database connections.</p>

<p>All shutdown hook providers will implement interface com.networknt.server.ShutdownHookProvider</p>

<pre><code>public interface ShutdownHookProvider {
    void onShutdown();
}

</code></pre>

<p>The onShutdown() in your implementation will be called before server shutdown.</p>

<h1 id="startup-hook-providers">Startup Hook Providers</h1>

<p>Startup hook providers are plugins that would be called during server startup in order to initialize
resources. For example, create database connection pool, load spring application context etc.</p>

<p>All startup hook providers will implement interface com.networknt.server.StartupHookProvider</p>

<pre><code>public interface StartupHookProvider {
    void onStartup();
}
</code></pre>

<p>The onStartup() in your implementation will be called before server startup.</p>

<h1 id="handler-provider">Handler Provider</h1>

<p>There is only one handler provider that is needed to wire in API implementations. In most of the
cases, it would be an instance of io.undertow.server.RoutingHandler just like the generated <a href="https://github.com/networknt/light-example-4j/tree/master/petstore">petstore
project</a>. However, it is not
limited and it can be several handlers chained together. One example is the
<a href="https://github.com/networknt/light-example-4j/tree/master/webserver">webserver example</a> and it
has several handlers chained together to provide API routing as well as static website. The handler
provide code can be found <a href="https://github.com/networknt/light-example-4j/blob/master/webserver/src/main/java/com/networknt/webserver/handler/WebServerHandlerProvider.java">here</a></p>

<p>If you have OpenAPI specification defined, this handler provider will be generated from
<a href="https://github.com/networknt/light-codegen">light-codegen</a>. <a href="https://github.com/networknt/light-example-4j/blob/master/petstore/src/main/java/io/swagger/handler/PathHandlerProvider.java">Here</a>
is a generated petstore handler provider that has the mapping for all endpoints.</p>

<p>The above is using light-rest-4j as example, for GraphQL and Hybrid, the handler provider will be
different.</p>

<p>Handler provider implements interface com.networknt.server.HandlerProvider</p>

<pre><code>public interface HandlerProvider {
    HttpHandler getHandler();
}

</code></pre>

<p>The getHandler() will return an HttpHandler or a chain of HttpHandlers wrapped together. This handler
will be called in the request/response chain right after all middleware handlers are called.</p>

<h1 id="middleware-handlers">Middleware Handlers</h1>

<p>There are some <a href="https://networknt.github.io/light-4j/middleware/">builtin middleware components</a>
in the framework to address common cross cutting concerns. There are implemented in a way we think
the best to meet most of business requirements. In other words, there are opinionated. For product
that built top of the framework, you can add/customize/replace existing middleware handlers.</p>

<p>All middleware handlers need to implement interface com.networknt.handler.MiddlewareHandler.</p>

<pre><code>public interface MiddlewareHandler extends HttpHandler {

    HttpHandler getNext();

    MiddlewareHandler setNext(final HttpHandler next);

    boolean isEnabled();

    void register();

}
</code></pre>

<p>boolean isEnabled()</p>

<p>Every middleware handler has a corresponding config file which is the same name lower case
with .json extension. There must be flag to indicate if the handle will be wired in during
server startup. This gives user a chance to temporary disable a particular middleware handler
without changing the SPI configuration.</p>

<p>void register()</p>

<p>This function will be called when the middleware is wired in the request/response chain. It registers
itself and configuration to server info component which can be accessed through a special endpoint
to get runtime information on middleware handlers and their configuration along with other system
info.</p>

<p>MiddlewareHandler setNext(final HttpHandler next)</p>

<p>As middleware handler are chained together, so the existing handler must be put in the current
handler as next. When the current handler is completed, it will call the next handler if there is
no error. And eventually, the user provided handler will be called if all middleware handler are
completed without an error.</p>

<h3 id="the-sequence-of-middleware-handlers">The sequence of middleware handlers.</h3>

<p>There are dependencies between middleware handlers so the sequence to plug them in is very important.</p>

<p>For default plugins generated from <a href="https://github.com/networknt/light-codegen">light-codegen</a>,
please refer to <a href="https://networknt.github.io/light-4j/other/server/">Server</a></p>

<h1 id="diagram">Diagram</h1>

<p><img src="https://networknt.github.io/images/handler_chain.png" alt="handler_chain" /></p>

<p>Note that audit, metrics and exception need to hooked in the response in order to handle exceptions
on both request and response phase, calculate response time and dump response info into the audit.</p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://networknt.github.io/middleware/traceability/" title="Traceability">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Traceability
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/other/info/" title="Server Info">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Server Info
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/';
      var repo_id  = 'networknt\/light-doc';
    
    </script>

    <script src="https://networknt.github.io/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

